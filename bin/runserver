#!/bin/bash

# Runs inabox in DEBUG mode with SQLITE

INABOX_DIR="/home/karasu/inabox"

cd ${INABOX_DIR}

echo "" > known_hosts

## Update all challenge's images
cd docker-images
./build-all
cd ..

RABBITMQ_CMD="docker-compose up rabbitmq"
REDIS_CMD="docker-compose up redis" 
CELERY_WORKER_CMD="celery -A inabox worker -l INFO"
CELERY_BEAT_CMD="celery -A inabox beat -l INFO --scheduler django_celery_beat.schedulers:DatabaseScheduler"
DJANGO_CMD="python manage.py runserver"

if [ "${XDG_SESSION_TYPE}" == "tty" ]; then
  ${RABBITMQ_CMD} &!
  ${REDIS_CMD} &!
  cd src
  ${CELERY_WORKER_CMD} &!
  ${CELERY_BEAT_CMD} &!
  ${DJANGO_CMD}
else
  kitty --detach --title "Celery worker" --directory "${INABOX_DIR}" ${RABBITMQ_CMD}
  kitty --detach --title "Celery worker" --directory "${INABOX_DIR}" ${REDIS_CMD}
  kitty --detach --title "Celery worker" --directory "${INABOX_DIR}/src" ${CELERY_WORKER_CMD}
  kitty --detach --title "Celery beat" --directory "${INABOX_DIR}/src" ${CELERY_BEAT_CMD}
  kitty --detach --title Daphne --directory ${INABOX_DIR}/src ${DJANGO_CMD}
fi
